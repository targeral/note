# fiber

## Reactå¦‚ä½•ä»¥åŠä¸ºä½•ä½¿ç”¨Fiberä¸­çš„é“¾è¡¨æ¥éå†ç»„ä»¶æ ‘

Fiberæ¶æ„ä¸»è¦æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼šreconciliation/render å’Œ commitã€‚åœ¨æºä»£ç ä¸­ï¼Œreconciliationæ®µä¸»è¦ç§°ä¸ºâ€œæ¸²æŸ“é˜¶æ®µâ€ã€‚è¿™ä¸ªé˜¶æ®µä¸»è¦æ˜¯åœ¨Reactéå†ç»„ä»¶ğŸŒ²ä»¥åŠ

* æ›´æ–°stateå’Œprops
* è°ƒç”¨ç”Ÿå‘½å‘¨æœŸé’©å­
* ä»ç»„ä»¶ä¸­æ£€ç´¢å­é¡¹
* æ¯”è¾ƒä»–ä»¬è·Ÿä¹‹å‰çš„å­é¡¹
* å¹¶è®¡ç®—å‡ºéœ€è¦æ‰§è¡Œçš„DOMæ›´æ–°ã€‚

ä»¥ä¸Šæ‰€æœ‰çš„æ´»åŠ¨éƒ½å±äºFiberçš„å·¥ä½œã€‚éœ€è¦å®Œæˆçš„å·¥ä½œç±»å‹å–å†³äºReact Elementçš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¯¹äºç±»ç»„ä»¶ï¼ŒReactéœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªç±»ï¼Œè€Œä¸æ˜¯ä¸ºåŠŸèƒ½ç»„ä»¶æ‰§è¡Œå®ƒã€‚æ‰€æœ‰çš„å·¥ä½œç±»å‹å¦‚ä¸‹ï¼š

``` js
/**
 * Copyright (c) 2013-present, Facebook, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * @flow
 */

export type WorkTag =
  | 0
  | 1
  | 2
  | 3
  | 4
  | 5
  | 6
  | 7
  | 8
  | 9
  | 10
  | 11
  | 12
  | 13
  | 14
  | 15
  | 16;

export const FunctionalComponent = 0;
export const FunctionalComponentLazy = 1;
export const ClassComponent = 2;
export const ClassComponentLazy = 3;
export const IndeterminateComponent = 4; // Before we know whether it is functional or class
export const HostRoot = 5; // Root of a host tree. Could be nested inside another node.
export const HostPortal = 6; // A subtree. Could be an entry point to a different renderer.
export const HostComponent = 7;
export const HostText = 8;
export const Fragment = 9;
export const Mode = 10;
export const ContextConsumer = 11;
export const ContextProvider = 12;
export const ForwardRef = 13;
export const ForwardRefLazy = 14;
export const Profiler = 15;
export const PlaceholderComponent = 16;
```

*åœ¨å¤„ç†UIæ—¶ï¼Œå¦‚æœä¸€æ¬¡æ‰§è¡Œå¤ªå¤šå·¥ä½œä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å¯èƒ½ä¼šå¯¼è‡´åŠ¨ç”»ä¸¢å¸§...*

é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼ŸåŸºæœ¬ä¸Šï¼Œå¦‚æœReactè¦åŒæ­¥éå†æ•´ä¸ªç»„ä»¶ä¹¦å¹¶ä¸ºæ¯ä¸ªç»„ä»¶æ‰§è¡Œå·¥ä½œï¼Œå®ƒæ‰§è¡Œè¿™äº›é€»è¾‘æ‰€èŠ±è´¹çš„æ—¶é—´å¯èƒ½ä¼šè¶…è¿‡16msã€‚è¿™å°†å¯¼è‡´æ‰å¸§ï¼Œè€Œæ‰å¸§ä¼šä½¿å¾—é¡µé¢å¡é¡¿ã€‚

æ‰€ä»¥reactåšçš„è¿™äº›å·¥ä½œè²Œä¼¼æ²¡æœ‰å¤ªå¤§å¸®åŠ©å˜›ï¼Ÿ

*è¾ƒæ–°çš„æµè§ˆå™¨ï¼ˆå’ŒReact Nativeï¼‰å®ç°äº†æœ‰åŠ©äºè§£å†³è¿™ä¸ªé—®é¢˜çš„API ...*

æ–°çš„APIæ˜¯ä¸€ä¸ªå«åš`requestIdleCallback`çš„å…¨å±€å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ç”¨äºåœ¨æµè§ˆå™¨ç©ºé—²æœŸé—´æ‰§è¡Œæ’åœ¨é˜Ÿåˆ—é‡Œçš„å‡½æ•°ã€‚å¦‚ä¸‹ä½¿ç”¨ï¼š

``` js
requestIdleCallback((deadline) => {
    console.log(deadline.timeRemaining(), deadline.didTimeout);
})
```

å¦‚æœæˆ‘ç°åœ¨æ‰“å¼€æ§åˆ¶å°å¹¶æ‰§è¡Œä¸Šé¢çš„ä»£ç ï¼ŒChromeä¼šè®°å½•`49.9 false`ã€‚
å®ƒåŸºæœ¬ä¸Šå‘Šè¯‰æˆ‘ï¼Œæˆ‘æœ‰49.9æ¯«ç§’å¯ä»¥åšæˆ‘éœ€è¦åšçš„ä»»ä½•å·¥ä½œï¼Œæˆ‘è¿˜æ²¡æœ‰ç”¨å®Œæ‰€æœ‰åˆ†é…çš„æ—¶é—´ï¼Œå¦åˆ™deadline.didTimeoutå°†æ˜¯`true`ã€‚è¯·è®°ä½ï¼ŒtimeRemainingå¯ä»¥åœ¨æµè§ˆå™¨å®ŒæˆæŸäº›å·¥ä½œåç«‹å³æ›´æ”¹ï¼Œå› æ­¤åº”è¯¥ä¸æ–­æ£€æŸ¥ã€‚


`requestIdleCallback`å®é™…ä¸Šæœ‰ç‚¹è¿‡äºä¸¥æ ¼ï¼Œå¹¶ä¸”æ‰§è¡Œå¾—ä¸å¤Ÿé¢‘ç¹ï¼Œæ— æ³•å®ç°æµç•…çš„UIå‘ˆç°ï¼Œå› æ­¤Reactå›¢é˜Ÿå¿…é¡»å®ç°è‡ªå·±çš„ç‰ˆæœ¬ã€‚

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬å°†Reactså¯¹ç»„ä»¶æ‰§è¡Œçš„æ‰€æœ‰æ´»åŠ¨æ”¾å…¥å‡½æ•°performWorkï¼Œå¹¶ä½¿ç”¨requestIdleCallbackæ¥å®‰æ’å·¥ä½œï¼Œæˆ‘ä»¬çš„ä»£ç å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š

``` js
requestIdleCallback(deadline => {
    while((deadline.timeRemaining() > 0 || deadline.didTimeout) && nextComponent) {
        nextComponent = performWork(nextComponent);
    }
});
```

æˆ‘ä»¬å¯¹ä¸€ä¸ªç»„ä»¶æ‰§è¡Œå·¥ä½œï¼Œç„¶åå°†è¿”å›åˆ°è¦å¤„ç†çš„ä¸‹ä¸€ä¸ªç»„ä»¶è¿›è¡Œå¤„ç†ã€‚
å¦‚æœä¸æ˜¯ä¸€ä»¶äº‹ï¼Œè¿™å°†æœ‰æ•ˆã€‚
æ‚¨æ— æ³•åŒæ­¥å¤„ç†æ•´ä¸ªç»„ä»¶æ ‘ï¼Œå¦‚ä»¥å‰çš„åè°ƒç®—æ³•å®ç°ä¸­æ‰€ç¤ºã€‚
è¿™å°±æ˜¯å®‰å¾·é²åœ¨è¿™é‡Œè°ˆåˆ°çš„é—®é¢˜ï¼š

*ä¸ºäº†ä½¿ç”¨è¿™äº›APIï¼Œæ‚¨éœ€è¦ä¸€ç§æ–¹æ³•å°†æ¸²æŸ“çš„å·¥ä½œåˆ†è§£ä¸ºå¢é‡å•å…ƒ*

å› æ­¤ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒReactå¿…é¡»é‡æ–°å®ç°éå†ğŸŒ²çš„ç®—æ³•â€”â€”ä»ä¾èµ–äºå†…ç½®å †æ ˆçš„åŒæ­¥é€’å½’æ¨¡å‹åˆ°å…·æœ‰é“¾è¡¨å’ŒæŒ‡é’ˆçš„å¼‚æ­¥æ¨¡å‹çš„æ ‘çš„ç®—æ³•ã€‚

å¦‚æœä½ åªä¾èµ–äº[å†…ç½®]è°ƒç”¨å †æ ˆï¼Œå®ƒå°†ä¸€ç›´å·¥ä½œç›´åˆ°å †æ ˆä¸ºç©º...å¦‚æœæˆ‘ä»¬å¯ä»¥éšæ„ä¸­æ–­è°ƒç”¨å †æ ˆå¹¶æ‰‹åŠ¨æ“ä½œå †æ ˆå¸§ï¼Œé‚£ä¼šä¸ä¼šå¾ˆå¥½ï¼Ÿè¿™å°±æ˜¯React Fiberçš„ç›®çš„ã€‚**Fiberæ˜¯é‡æ–°å®ç°çš„å †æ ˆï¼Œä¸“é—¨ç”¨äºReactç»„ä»¶ã€‚**
æ‚¨å¯ä»¥å°†å•ä¸ªfiberè§†ä¸ºä¸€ä¸ªè™šæ‹Ÿå †æ ˆå¸§ã€‚

### å…³äºå †æ ˆ

æˆ‘çŒœä½ ä»¬éƒ½ç†Ÿæ‚‰è°ƒç”¨å †æ ˆçš„æ¦‚å¿µã€‚
å¦‚æœæ‚¨åœ¨æ–­ç‚¹å¤„æš‚åœä»£ç ï¼Œåˆ™å¯ä»¥åœ¨æµè§ˆå™¨çš„è°ƒè¯•å·¥å…·ä¸­çœ‹åˆ°ã€‚
ä»¥ä¸‹æ˜¯ç»´åŸºç™¾ç§‘çš„ä¸€äº›ç›¸å…³å¼•ç”¨å’Œå›¾è¡¨ï¼š

*åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œè°ƒç”¨å †æ ˆæ˜¯ä¸€ç§å †æ ˆæ•°æ®ç»“æ„ï¼Œå®ƒå­˜å‚¨æœ‰å…³è®¡ç®—æœºç¨‹åºçš„æ´»åŠ¨å­ç¨‹åºçš„ä¿¡æ¯...å…·æœ‰è°ƒç”¨å †æ ˆçš„ä¸»è¦åŸå› æ˜¯è·Ÿè¸ªæ¯ä¸ªæ´»åŠ¨å­ç¨‹åºåœ¨å®Œæˆæ‰§è¡Œæ—¶åº”è¿”å›æ§åˆ¶çš„ç‚¹...è°ƒç”¨å †æ ˆç”±å †æ ˆå¸§ç»„æˆ...æ¯ä¸ªå †æ ˆå¸§å¯¹åº”äºå¯¹å°šæœªä»¥è¿”å›ç»ˆæ­¢çš„å­ä¾‹ç¨‹çš„è°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªåä¸ºDrawLineçš„å­ç¨‹åºå½“å‰æ­£åœ¨è¿è¡Œï¼Œç”±å­ç¨‹åºDrawSquareè°ƒç”¨ï¼Œåˆ™è°ƒç”¨å †æ ˆçš„é¡¶éƒ¨å¯èƒ½ä¼šåƒåœ¨ç›¸é‚»çš„å›¾ç‰‡ä¸­ä¸€æ ·å¸ƒå±€ã€‚*

[è°ƒç”¨å †æ ˆå¸§](./imgs/1_WqEscsoRHItF0p4fZjHfsA.png)


### ä¸ºä»€ä¹ˆå †æ ˆä¸Reactç›¸å…³ï¼Ÿ

æ­£å¦‚æˆ‘ä»¬åœ¨æœ¬æ–‡çš„ç¬¬ä¸€éƒ¨åˆ†ä¸­æ‰€å®šä¹‰çš„ï¼ŒReactsåœ¨ reconciliation/render é˜¶æ®µæ‰§è¡Œç»„ä»¶æ ‘ï¼Œå¹¶ä¸ºç»„ä»¶æ‰§è¡Œä¸€äº›å·¥ä½œã€‚åè°ƒå™¨çš„å…ˆå‰å®ç°ä½¿ç”¨ä¾èµ–äºå†…ç½®å †æ ˆçš„åŒæ­¥é€’å½’æ¨¡å‹æ¥éå†æ ‘ã€‚å…³äºå’Œè§£çš„å®˜æ–¹æ–‡æ¡£æè¿°äº†è¿™ä¸ªè¿‡ç¨‹ï¼Œå¹¶è°ˆè®ºäº†å¾ˆå¤šå…³äºé€’å½’çš„å†…å®¹ï¼š

*é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å¯¹DOMèŠ‚ç‚¹çš„å­èŠ‚ç‚¹è¿›è¡Œé€’å½’æ—¶ï¼ŒReactä¼šåŒæ—¶è¿­ä»£ä¸¤ä¸ªå­èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¹¶åœ¨å‡ºç°å·®å¼‚æ—¶ç”Ÿæˆçªå˜ã€‚*

å¦‚æœä½ è€ƒè™‘ä¸€ä¸‹ï¼Œæ¯ä¸ªé€’å½’è°ƒç”¨éƒ½ä¼šå‘å †æ ˆæ·»åŠ ä¸€ä¸ªå¸§ã€‚å®ƒåŒæ­¥è¿™æ ·åšã€‚å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ç»„ä»¶æ ‘ï¼š

[](./imgs/1_TYWa1WAZ9iLip-rwBNPGEQ.png)

å‡è®¾ä¸‹é¢çš„å¯¹è±¡éƒ½æœ‰renderå‡½æ•°ã€‚ä½ å¯ä»¥å°†å®ƒä»¬è§†ä¸ºç»„ä»¶çš„å®ä¾‹ï¼š

``` js
const a1 = {name: 'a1'};
const b1 = {name: 'b1'};
const b2 = {name: 'b2'};
const b3 = {name: 'b3'};
const c1 = {name: 'c1'};
const c2 = {name: 'c2'};
const d1 = {name: 'd1'};
const d2 = {name: 'd2'};

a1.render = () => [b1, b2, b3];
b1.render = () => [];
b2.render = () => [c1];
b3.render = () => [c2];
c1.render = () => [d1, d2];
c2.render = () => [];
d1.render = () => [];
d2.render = () => [];
```

Reactéœ€è¦è¿­ä»£ğŸŒ²å¹¶ä¸”å¯¹ç»„ä»¶åšç›¸åº”çš„å·¥ä½œã€‚ä¸ºç®€åŒ–èµ·è§ï¼Œè¦åšçš„å·¥ä½œæ˜¯è®°å½•å½“å‰ç»„ä»¶åç§°å¹¶ä¸”æ£€ç´¢å®ƒè‡ªå·±çš„å­ç»„ä»¶ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹æˆ‘ä»¬å¦‚ä½•é€’å½’å¤„ç†ä»–ä»¬ï¼š

### é€’å½’éå†

è¿­ä»£æ ‘çš„ä¸»è¦å‡½æ•°åœ¨ä¸‹é¢çš„å®ç°ä¸­ç§°ä¸º `walk`ï¼š

``` js
walk(a1);

function walk(instance) {
    doWork(instance);
    const children = instance.render();
    children.forEach(walk);
}

function doWork(o) {
    console.log(o.name);
}
```

è¿™æ˜¯æˆ‘ä»¬å¾—åˆ°çš„è¾“å‡ºï¼š

```
a1, b1, b2, c1, d1, d2, b3, c2
```

é€’å½’æ–¹æ³•ç›´è§‚ï¼Œéå¸¸é€‚åˆéå†æ ‘ã€‚ä½†æ­£å¦‚æˆ‘ä»¬å‘ç°çš„é‚£æ ·ï¼Œå®ƒæœ‰å±€é™æ€§ã€‚æœ€å¤§çš„ä¸€ç‚¹æ˜¯æˆ‘ä»¬ä¸èƒ½å°†å·¥ä½œåˆ†è§£ä¸ºå¢é‡å•ä½ã€‚æˆ‘ä»¬ä¸èƒ½æš‚åœç‰¹å®šç»„ä»¶çš„å·¥ä½œå¹¶åœ¨ä»¥åæ¢å¤ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼ŒReactåªæ˜¯ç»§ç»­è¿­ä»£ï¼Œç›´åˆ°å®ƒå¤„ç†æ‰€æœ‰ç»„ä»¶å¹¶ä¸”å †æ ˆä¸ºç©ºã€‚

**é‚£ä¹ˆReactå¦‚ä½•å®ç°ç®—æ³•åœ¨æ²¡æœ‰é€’å½’çš„æƒ…å†µä¸‹éå†æ ‘ï¼Ÿå®ƒä½¿ç”¨å•é“¾è¡¨æ ‘éå†ç®—æ³•ã€‚å®ƒå¯ä»¥æš‚åœéå†å¹¶é˜»æ­¢å †æ ˆå¢é•¿**

### é“¾è¡¨éå†

è¦å®ç°è¯¥ç®—æ³•ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŒ…å«3ä¸ªå­—æ®µçš„æ•°æ®ç»“æ„ï¼š

* child â€”â€” ä»£è¡¨ç¬¬ä¸€ä¸ªå­é¡¹
* sibling â€”â€” ä»£è¡¨ç¬¬ä¸€ä¸ªå…„å¼Ÿé¡¹
* return â€”â€” ä»£è¡¨çˆ¶é¡¹

åœ¨Reactä¸­çš„ reconciliation ç®—æ³•çš„å†…å®¹ä¸­ï¼Œå…·æœ‰è¿™äº›å­—æ®µçš„æ•°æ®ç»“æ„ç§°ä¸º Fiberã€‚å®ƒä»£è¡¨äº†ä¸€ä¸ªReact Elementï¼Œè¿™ä¸ªå…ƒç´ ç”¨äºç»´æŒä¸€ä¸ªå€™é€‰å·¥ä½œé˜Ÿåˆ—ã€‚

ä¸‹å›¾æ¼”ç¤ºäº†é€šè¿‡é“¾è¡¨é“¾æ¥çš„å¯¹è±¡çš„å±‚æ¬¡ç»“æ„ä»¥åŠå®ƒä»¬ä¹‹é—´çš„è¿æ¥ç±»å‹ï¼š

[](./imgs/1_7dsyUaUpKbFG7EoNR9Cu2w.png)

æ‰€ä»¥è®©æˆ‘ä»¬é¦–å…ˆå®šä¹‰æˆ‘ä»¬çš„è‡ªå®šä¹‰èŠ‚ç‚¹æ„é€ å‡½æ•°ï¼š

``` js
class Node {
    constructor(instance) {
        this.instance = instance;
        this.child = null;
        this.sibling = null;
        this.return = null;
    }
}
```

ä»¥åŠè·å–èŠ‚ç‚¹æ•°ç»„å¹¶å°†å®ƒä»¬é“¾æ¥åœ¨ä¸€èµ·çš„å‡½æ•°ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥é“¾æ¥renderæ–¹æ³•è¿”å›çš„å­èŠ‚ç‚¹ï¼š

``` js
function link(parent, elements) {
    if (elements === null) elements = [];

    parent.child = elements.reduceRight((previous, current) => {
        const node = new Node(current);
        node.return = parent;
        node.sibling = previous;
        return node;
    }, null);

    return parent.child;
}
```

è¯¥å‡½æ•°ä»æœ€åä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹è¿­ä»£èŠ‚ç‚¹æ•°ç»„ï¼Œå¹¶åœ¨å•ä¸ªé“¾è¡¨ä¸­å°†å®ƒä»¬é“¾æ¥åœ¨ä¸€èµ·ã€‚å®ƒè¿”å›åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªå…„å¼Ÿçš„å¼•ç”¨ã€‚è¿™æ˜¯ä¸€ä¸ªå¦‚ä½•å·¥ä½œçš„ç®€å•æ¼”ç¤ºï¼š

``` js
const children = [{name: 'b1'}, {name: 'b2'}];
const parent = new Node({name: 'a1'});
const child = link(parent, children);

// the following two statements are true
console.log(child.instance.name === 'b1');
console.log(child.sibling.instance === children[1]);
```

æˆ‘ä»¬è¿˜å°†å®ç°ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œä¸ºèŠ‚ç‚¹æ‰§è¡Œä¸€äº›å·¥ä½œã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒå°†è®°å½•ç»„ä»¶çš„åç§°ã€‚ä½†é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜æ£€ç´¢ç»„ä»¶çš„å­é¡¹å¹¶å°†å®ƒä»¬é“¾æ¥åœ¨ä¸€èµ·ï¼š

``` js
function doWork(node) {
    console.log(node.instance.name);
    const children = node.instance.render();
    return link(node, children);
}
```

å¥½çš„ï¼Œä¸»è¦çš„éå†ç®—æ³•çš„å®ç°æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†ã€‚é¦–å…ˆæ˜¯ä¸€ä¸ªçˆ¶å…ƒç´ ï¼Œã€‚è¿™é‡Œæ˜¯æœ‰ç”¨çš„ä»£ç å’Œæ³¨é‡Šï¼š

``` js
function walk(o) {
    let root = o;
    let current = o;

    while (true) {
        // perform work for a node, retrieve & link the children
        let child = doWork(current);

        // if there's a child, set it as the current active node
        if (child) {
            current = child;
            continue;
        }

        // if we've returned to the top, exit the function
        if (current === root) {
            return;
        }

        // keep going up until we find the sibling
        while (!current.sibling) {

            // if we've returned to the top, exit the function
            if (!current.return || current.return === root) {
                return;
            }

            // set the parent as the current active node
            current = current.return;
        }

        // if found, set the sibling as the current active node
        current = current.sibling;
    }
}
```

è™½ç„¶å®ç°èµ·æ¥å¹¶ä¸æ˜¯ç‰¹åˆ«éš¾ä»¥ç†è§£ï¼Œä½†æ‚¨å¯èƒ½éœ€è¦ç¨å¾®å°è¯•ä¸€ä¸‹è¿è¡Œä»£ç æ‰èƒ½ç†è§£å®ƒã€‚æˆ‘ä»¬çš„æƒ³æ³•æ˜¯ä¿æŒå¯¹å½“å‰èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œå¹¶åœ¨ä¸‹é™æ ‘æ—¶é‡æ–°åˆ†é…å®ƒï¼Œç›´åˆ°æˆ‘ä»¬åˆ°è¾¾åˆ†æ”¯çš„æœ«å°¾ã€‚
ç„¶åæˆ‘ä»¬ä½¿ç”¨ `return` æŒ‡é’ˆè¿”å›å…¬å…±çˆ¶çº§ã€‚

å¦‚æœæˆ‘ä»¬ç°åœ¨ä½¿ç”¨æ­¤ä»£ç å®ç°æ£€æŸ¥è°ƒç”¨å †æ ˆï¼Œè¿™æ˜¯æˆ‘ä»¬å°†è¦çœ‹åˆ°çš„å†…å®¹ï¼š

[](./imgs/1_ybVgRoNf-dBxR_OKxn4oKQ.gif)

æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œå½“æˆ‘ä»¬æ²¿ç€æ ‘èµ°æ—¶ï¼Œå †æ ˆä¸ä¼šå¢é•¿ã€‚ä½†æ˜¯å¦‚æœç°åœ¨å°†è°ƒè¯•å™¨æ”¾å…¥doWorkå‡½æ•°å¹¶è®°å½•èŠ‚ç‚¹åç§°ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š

[](./imgs/1_ErzqXpJt5KkLKxHCn31hmA.gif)

å®ƒçœ‹èµ·æ¥åƒæµè§ˆå™¨ä¸­çš„è°ƒç”¨æ ˆã€‚å› æ­¤ï¼Œä½¿ç”¨è¿™ç§ç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æˆ‘ä»¬è‡ªå·±çš„å®ç°æœ‰æ•ˆåœ°æ›¿æ¢æµè§ˆå™¨çš„è°ƒç”¨å †æ ˆå®ç°ã€‚è¿™å°±æ˜¯å®‰å¾·é²åœ¨è¿™é‡Œæ‰€æè¿°çš„ï¼š

*Fiberæ˜¯é‡æ–°å®ç°çš„å †æ ˆï¼Œä¸“é—¨ç”¨äºReactç»„ä»¶ã€‚æ‚¨å¯ä»¥å°†å•ä¸ªfiberè§†ä¸ºè™šæ‹Ÿå †æ ˆå¸§*

å› æ­¤æˆ‘ä»¬ç°åœ¨é€šè¿‡ä¿ç•™å……å½“é¡¶éƒ¨å¸§çš„èŠ‚ç‚¹çš„å¼•ç”¨æ¥æ§åˆ¶å †æ ˆã€‚

``` js
function walk(o) {
    let root = o;
    let current = o;

    while (true) {
            ...

            current = child;
            ...
            
            current = current.return;
            ...

            current = current.sibling;
    }
}
```

æˆ‘ä»¬å¯ä»¥éšæ—¶åœæ­¢éå†å¹¶ç¨åæ¢å¤ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦å®ç°çš„èƒ½å¤Ÿä½¿ç”¨æ–°çš„requestIdleCallback APIçš„æ¡ä»¶ã€‚

### Reactä¸­çš„å·¥ä½œå¾ªç¯

è¿™æ˜¯åœ¨Reactä¸­å®ç°å·¥ä½œå¾ªç¯çš„ä»£ç ï¼š

``` js
function workLoop(isYieldy) {
    if (!isYieldy) {
        // Flush work without yielding
        while (nextUnitOfWork !== null) {
            nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
        }
    } else {
        // Flush asynchronous work until the deadline runs out of time.
        while (nextUnitOfWork !== null && !shouldYield()) {
            nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
        }
    }
}
```

å¦‚æ‚¨æ‰€è§ï¼Œå®ƒå¾ˆå¥½åœ°æ˜ å°„åˆ°æˆ‘ä¸Šé¢æåˆ°çš„ç®—æ³•ã€‚å®ƒä¿ç•™å¯¹nextUnitOfWorkå˜é‡ä¸­å½“å‰å…‰çº¤èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œè¯¥å˜é‡å……å½“é¡¶éƒ¨å¸§ã€‚

è¯¥ç®—æ³•å¯ä»¥åŒæ­¥éå†ç»„ä»¶æ ‘ï¼Œå¹¶ä¸ºæ ‘ä¸­çš„æ¯ä¸ªå…‰çº¤èŠ‚ç‚¹æ‰§è¡Œå·¥ä½œï¼ˆnextUnitOfWorkï¼‰ã€‚è¿™é€šå¸¸æ˜¯ç”±UIäº‹ä»¶ï¼ˆç‚¹å‡»ï¼Œè¾“å…¥ç­‰ï¼‰å¼•èµ·çš„æ‰€è°“äº¤äº’å¼æ›´æ–°çš„æƒ…å†µã€‚æˆ–è€…å®ƒå¯ä»¥å¼‚æ­¥åœ°éå†ç»„ä»¶æ ‘ï¼Œæ£€æŸ¥åœ¨æ‰§è¡Œå…‰çº¤èŠ‚ç‚¹å·¥ä½œåæ˜¯å¦è¿˜å‰©ä¸‹æ—¶é—´ã€‚å‡½æ•°shouldYieldè¿”å›åŸºäºdeadlineDidExpireå’Œdeadlineå˜é‡çš„ç»“æœï¼Œè¿™äº›å˜é‡åœ¨Reactä¸ºå…‰çº¤èŠ‚ç‚¹æ‰§è¡Œå·¥ä½œæ—¶ä¸æ–­æ›´æ–°ã€‚


## æ·±å…¥Fiberï¼šæ·±å…¥æ¦‚è¿°Reactä¸­çš„æ–°åè°ƒç®—æ³•

Reactæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢çš„JavaScriptåº“ã€‚å…¶æ ¸å¿ƒæœºåˆ¶æ˜¯è·Ÿè¸ªç»„ä»¶çŠ¶æ€å˜åŒ–å¹¶å°†æ›´æ–°çš„çŠ¶æ€æŠ•å½±åˆ°å±å¹•ã€‚åœ¨Reactä¸­ï¼Œæˆ‘ä»¬å°†æ­¤è¿‡ç¨‹è§†ä¸º**åè°ƒï¼ˆ reconciliationï¼‰**ã€‚æˆ‘ä»¬è°ƒç”¨ `setState` æ–¹æ³•çš„æ—¶å€™ï¼Œæ¡†æ¶æ£€æŸ¥ `state` å’Œ `props` æ˜¯å¦æœ‰æ”¹å˜å¹¶ä¸”åœ¨UIä¸Šè¿›è¡Œé‡æ–°æ¸²æŸ“å‘ˆç°ç»„ä»¶ã€‚

Reactçš„æ–‡æ¡£æä¾›äº†è¯¥æœºåˆ¶ä¸€ä¸ªä¸é”™çš„é«˜çº§æ¦‚è¿°ï¼šReactå…ƒç´ çš„ä½œç”¨ï¼Œç”Ÿå‘½å‘¨æœŸæ–¹æ³•å’Œ `render` æ–¹æ³•ï¼Œä»¥åŠåº”ç”¨äºç»„ä»¶å­å…ƒç´ çš„diffingç®—æ³•ã€‚ä»renderæ–¹æ³•è¿”å›çš„ä¸å¯å˜Reactå…ƒç´ æ ‘é€šå¸¸ç§°ä¸ºâ€œè™šæ‹ŸDOMâ€ã€‚è¿™ä¸ªæœ¯è¯­æœ‰åŠ©äºæ—©æœŸå‘äººä»¬è§£é‡ŠReactï¼Œä½†å®ƒä¹Ÿå¼•èµ·äº†æ··ä¹±ï¼Œå¹¶ä¸”ä¸å†åœ¨Reactæ–‡æ¡£ä¸­ä½¿ç”¨ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†åšæŒç§°å®ƒä¸ºReactå…ƒç´ çš„æ ‘ã€‚

é™¤äº†Reactå…ƒç´ çš„æ ‘ä¹‹å¤–ï¼Œæ¡†æ¶æ€»æ˜¯æœ‰ä¸€ä¸ªç”¨äºä¿æŒçŠ¶æ€çš„å†…éƒ¨å®ä¾‹æ ‘ï¼ˆç»„ä»¶ï¼ŒDOMèŠ‚ç‚¹ç­‰ï¼‰ã€‚ä»ç‰ˆæœ¬16å¼€å§‹ï¼ŒReactæ¨å‡ºäº†è¯¥å†…éƒ¨å®ä¾‹æ ‘çš„æ–°å®ç°ä»¥åŠç®¡ç†ä»£å·ä¸ºFiberçš„ç®—æ³•ã€‚

è¿™æ˜¯æœ¬ç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œæ—¨åœ¨æ•™ä½ Reactçš„å†…éƒ¨æ¶æ„ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³æä¾›ä¸ç®—æ³•ç›¸å…³çš„é‡è¦æ¦‚å¿µå’Œæ•°æ®ç»“æ„çš„æ·±å…¥æ¦‚è¿°ã€‚ä¸€æ—¦æˆ‘ä»¬æœ‰è¶³å¤Ÿçš„èƒŒæ™¯ï¼Œæˆ‘ä»¬å°†æ¢ç´¢ç”¨äºéå†å’Œå¤„ç†fiberæ ‘çš„ç®—æ³•å’Œä¸»è¦åŠŸèƒ½ã€‚æœ¬ç³»åˆ—çš„ä¸‹ä¸€ç¯‡æ–‡ç« å°†æ¼”ç¤ºReactå¦‚ä½•ä½¿ç”¨è¯¥ç®—æ³•æ‰§è¡Œåˆå§‹æ¸²æŸ“å’Œå¤„ç†çŠ¶æ€ä»¥åŠé“å…·æ›´æ–°ã€‚ä»é‚£é‡Œæˆ‘ä»¬å°†ç»§ç»­è®¨è®ºè°ƒåº¦ç¨‹åºçš„è¯¦ç»†ä¿¡æ¯ï¼Œå­åè°ƒè¿‡ç¨‹ä»¥åŠæ„å»ºæ•ˆæœåˆ—è¡¨çš„æœºåˆ¶ã€‚

### èƒŒæ™¯

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘å°†åœ¨æ•´ä¸ªç³»åˆ—ä¸­ä½¿ç”¨ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªæŒ‰é’®ï¼Œåªæ˜¯å¢åŠ å±å¹•ä¸Šå‘ˆç°çš„æ•°å­—ï¼š

[](./imgs/1_jTWOx6Yr6JyBV5ETnp4TRQ.gif)

ä»£ç å®ç°å¦‚ä¸‹ï¼š

``` js
class ClickCounter extends React.Component {
    constructor(props) {
        super(props);
        this.state = {count: 0};
        this.handleClick = this.handleClick.bind(this);
    }

    handleClick() {
        this.setState((state) => {
            return {count: state.count + 1};
        });
    }


    render() {
        return [
            <button key="1" onClick={this.handleClick}>Update counter</button>,
            <span key="2">{this.state.count}</span>
        ]
    }
}
```

å¦‚æ‚¨æ‰€è§ï¼Œå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„ç»„ä»¶ï¼Œå®ƒä»renderæ–¹æ³•è¿”å›ä¸¤ä¸ªå­å…ƒç´  **button**å’Œ **span**ã€‚å•å‡»è¯¥æŒ‰é’®åï¼Œå›è°ƒå‡½æ•°ä½¿å¾—ç»„ä»¶çš„çŠ¶æ€æ›´æ–°ã€‚ç´§æ¥ç€ï¼ŒçŠ¶æ€çš„æ”¹å˜ä¼šå¯¼è‡´spanå…ƒç´ çš„æ–‡æœ¬æ›´æ–°ã€‚

Reactåœ¨ **reconciliation** æœŸé—´æ‰§è¡Œå„ç§æ´»åŠ¨ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯Reactåœ¨æˆ‘ä»¬çš„ç®€å•åº”ç”¨ç¨‹åºä¸­çš„ç¬¬ä¸€æ¬¡æ¸²æŸ“å’ŒçŠ¶æ€æ›´æ–°ä¹‹åæ‰§è¡Œçš„é«˜çº§æ“ä½œï¼š

* æ›´æ–°ClickCounterçŠ¶æ€ä¸­çš„è®¡æ•°å±æ€§
* æ£€ç´¢å¹¶æ¯”è¾ƒ **ClickCounter** å’Œå®ƒä»¬çš„props
* æ›´æ–°spanå…ƒç´ çš„props

åœ¨æœŸ **reconciliation** é—´æ‰§è¡Œçš„å…¶ä»–æ´»åŠ¨åŒ…æ‹¬è°ƒç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æˆ–æ›´æ–° `refs`ã€‚**æ‰€æœ‰è¿™äº›æ´»åŠ¨åœ¨fiberæ¶æ„ä¸­ç»Ÿç§°ä¸ºâ€œå·¥ä½œâ€**ã€‚å·¥ä½œç±»å‹é€šå¸¸å–å†³äºReactå…ƒç´ çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¯¹äºç±»ç»„ä»¶ï¼ŒReactéœ€è¦åˆ›å»ºå®ä¾‹ï¼Œç„¶è€Œå¯¹äºå‡½æ•°ç»„ä»¶ä¸éœ€è¦è¿™æ ·åšã€‚å¦‚æ‚¨æ‰€çŸ¥ï¼ŒReactå…ƒç´ ä¸­æœ‰è®¸å¤šç§ç±»å‹ï¼Œä¾‹å¦‚ï¼šç±»å’Œå‡½æ•°ç»„ä»¶ï¼Œå®¿ä¸»ç»„ä»¶ï¼ˆDOMèŠ‚ç‚¹ï¼‰ï¼Œportalsç­‰.Reactå…ƒç´ çš„ç±»å‹ç”±createElementå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å®šä¹‰ã€‚æ­¤å‡½æ•°é€šå¸¸åœ¨renderæ–¹æ³•ä¸­è¢«ä½¿ç”¨ï¼Œç”¨äºåˆ›å»ºå…ƒç´ ã€‚

åœ¨æˆ‘ä»¬å¼€å§‹ç ”ç©¶å„ç§å·¥ä½œæ´»åŠ¨å’Œfiberä¸»è¦çš„ç®—æ³•ä¹‹å‰ï¼Œè®©æˆ‘ä»¬é¦–å…ˆç†Ÿæ‚‰Reactå†…éƒ¨ä½¿ç”¨çš„æ•°æ®ç»“æ„ã€‚

### ä»Reactå…ƒç´ åˆ°FiberèŠ‚ç‚¹

åœ¨Reactä¸­æ¯ä¸€ä¸ªç»„ä»¶æœ‰ä¸€ä¸ªç”± **render** æ–¹æ³•è¿”å›çš„æˆ‘ä»¬ç§°ä¹‹ä¸ºè§†å›¾æˆ–è€…æ¨¡æ¿çš„UIè¡¨ç¤ºã€‚å¯¹äºæˆ‘ä»¬çš„ **ClickCounter** ç»„ä»¶çš„æ¨¡æ¿å¦‚ä¸‹ï¼š

``` html
<button key="1" onClick={this.onClick}>Update counter</button>
<span key="2">{this.state.count}</span>
```


## é“¾æ¥

* https://medium.com/react-in-depth/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7
* https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e ï¼ˆcurrentï¼‰
* https://blog.angularindepth.com/what-every-front-end-developer-should-know-about-change-detection-in-angular-and-react-508f83f58c6a